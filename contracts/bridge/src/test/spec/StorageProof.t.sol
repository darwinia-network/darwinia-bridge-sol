// SPDX-License-Identifier: MIT

pragma solidity 0.7.6;

import "../test.sol";
import "../../spec/StorageProof.sol";
import "../../utils/rlp/RLPEncode.sol";

contract StorageProofTest is DSTest {

    function test_verify_single_storage_proof() public {
        bytes32 root = 0xb85b566e523eab932fb0a61d793849eb87db81c39b008d9146589423eee299f1;
        address account = 0x2091125994a6836252118Ddae37d019F8E6CA455;
        bytes[] memory account_proof = new bytes[](8);
        account_proof[0] = RLPEncode.writeBytes(hex'f90211a02b197aa094abdb8f1a71c8523b5fbced57c31a9b9baed2d41c180c7bbbaccee8a00b5bb0c2b428df4059129cba76d01c3547ea485bc4cad1fbb1c65f6f496ba09fa05b6635866f9c2600a293784bd3f0e3ccbc49e31bb49057ff4a163e9b40feb860a0414c4489b1c1157a559228cf3836a690098bf30ee49c7b20c63d069536db53f9a0c35ca7a85560b146fa40d95896b9e0f0efc246a72f3ed552182f4937741669bfa02fd583b6cbd2f094f1bd7187a59f30660f775af6f00861a02c12b01203b0807ba06601b9213fb3c1152886620f0aa6d76c598878e782eb7d5353aeaf20d7ffb9aba0e946ea8c488924c734454edd585bdf64929f861ad9c0a672c6cb11e5994d621ba02bd7fe141350cb43b56bcf202654810ab8eb6b527cc0f85a548a7a13be115ffda010226b47d92a228aa79752fcddd4f483236df7988786a1c014dc7467f8397179a0baa67930fb41c14b734d3ffc777fdabbbf2012ac8619586d9143c6e0d4fdb4eaa07df12c126be51db32da195b73351515059255867352d94976d9b73758ebec4d9a030a750d67de6c90565e2f6f13dc2ff042a27f8f5f5f4f2e421633f9aea26c478a0f0e15c129747041867f0f21a1e0eaad8d8be22835d9bdd6f9db7cb1d1d36a68aa00d8d917584c25fe09f31ed8af1578d45e4b7c5ec55d8e4e00b871b36481cff5ea0b9c4aada8c74d0773276dca8967b60a8c49074c05b7f7adae4ae3038ab38e5d480');
        account_proof[1] = RLPEncode.writeBytes(hex'f90211a075573c7a6256004d0c8277fe4a25fe2b79a385fe718c223f80adfe12faf75131a08621c559e68942d42e3996c10b51b854f89d25f6393ac9d1c8a9dbf948ea8541a00e56b5561311bebc5818f941e259d9c732b2276895b9726d0316e5466a6fb807a0ee682e275a0fbfaaa61354e89bff6782fdbc3afaa7071fb3f888bb96485b741ba052d2e23bba6ff2dd5699d1a0a5e90582e25921d0fc156de563f97059667d320da0838c42f4b0a3dd62822a17f1fa17901fb7c681e8cc772e57b0a4ac078845dbb2a032248e368afdf9cab9ad5c209608a89dc1e59b9a001df78d09199dde7ee43184a0693844a68419c98b3366cad719b69f230a92203863b9b49aec000ff53f800843a07221eb547df126f2e5f66f8d331c35a663b407af16f312320ba77235d3377c74a07e0a761071eeb15e0582e9e61f8247dbfc7e0125ecfcbe3d3e6201ecde2cf1f2a06bf4053d9cac9e9bac37155a9a4ce2acd7e57131f71eac15627e5c2923da2b0aa04782d358da3d3202971989f8b2cd3f73c35f3bd22d0a85945febcc180572c5bfa035490fdb74d8115bfa4247592ba493f3dc8b5ff2510e5e6d8718bd568ea10fb5a07604858fa9f57e90dc12c334cc0cb2024db8dbdada47922253f358024663d9afa03785f9c1324ecc2cb7c68cfac77a13ce9bcc3dbb409d57902e39454e61571d82a0158dc7a21abfd0399ff6c58cf941609343f8e58e6912b598b433acf9f5cc995380');
        account_proof[2] = RLPEncode.writeBytes(hex'f90211a02eb1a98845cbe6fa6696168e5e3f8a0accebbb2a823bfdfe874e51c71d396ca8a09b47207b9ea57fc32a066e8eb9cdfb66970205d9d76cc936ef4328769db7a941a022d93623f2a5d8b7439de7cdf4f7a5aa64b04212053cde623bfe72877863ccb0a074e9a8588b83b2d1b5539fe59fb8e58c54f53339ca121e2eb98783f524a84409a0c5caf472d5fe09fbcc1ceed7f2822b4fd38b4f7de8265d5cfe3f151c23e49dfca02b82576afb1da86f074be7c528a88a1f3a2eae480aa91166dc531cdf6aa32d4ca0fc795aace50b3b2304e14549159f289408fe785bd52779fc08d18e1e7afc6d3fa0e6ce4e99d8753862e0233a7522dc0632becc77aa5e2a6a9cba434723a761b7eaa071a7c9f7748f688108284d3c7afdd19d0ab42240b1ea0df46dc2f7071964be4ba0f2d5f99d3c792afe437b5c59cbeb24c0a11ec12247fabdfc6a755fba88eb9c93a05b0d9202babdd9d11985f79a346b2a81f70b1feca862da9c92ae7dfd52ee978fa011d6093571d26873add93c65c7d123d5aac2d259bca9acdbf19ffb59691ccf02a09e04686fc93c8f65b8c31b56b2ed1c482241cdababbcf9fda1d683d7aa8fb9bfa039a7dab838b90eb70776811fad1104dfb2713508c27207123e04a251c371db4ca02a2db4e2b41e2c31a5b9d67fe2ded77e4fa83bb126b3b32599b10f88ec62fbf9a033b660a93c0b12d40ee969e9cc9a4edfb8ef3a0fb71786ea3339b1cbd699d6ff80');
        account_proof[3] = RLPEncode.writeBytes(hex'f90211a0487ebf42ad517e3fb77a40021eda9095da276ac0cc5e8e94fa54b4e8b6f9faf3a02006ef6f7f0fec79431ca4e90f785b7c8c14b60c65eb46cfcb793eada0e69be1a0145455c17c76e27a40433e2dca22c1201e023ee22eecafcbd39e9958933a0e6ba0b7112c592547d1e9722168107b4b2c983b049892e5fb72e86b9933d06261d0cca0a0989231d89c310c715838d19acfb1f750be4076a548d1403fd11d6b72182a42a0f262dba2c10c5a31a2e26eb657286d99c3ab4079f4d59a0d5eefe59310998b6ca061280198c681d65e7104a9e3365775605b7b6d7862a0e8da65e713182cdfb7dca07ffd524f73b6ac9f94485a1d2620e2dbe2c306d6575a6973e1fc083f9ddca912a08c31fa832b473b58d42fe4ab8c3fb80bed135bb6f58724e763d8fb6ebc012006a0613baa32a58881fbe4ca58f04dc1209d81317cff4415e3484ab672f11e22324ba04285388cf9779366dc221167f95c57dbd60f6797986468f535b024a9ea69595aa06669327882c049fb3cbd113302964643b0c538b124144e2a532b5f827ac60d14a0877393867e668bd78df09af6a491ad7e63faa1883473c549c6ec8358a1a57568a009c0226243b42847d1c7e2f273cbfa413cf3283966f54e1d75bd70ad8ee26fe6a0d4c752b873991c0d69949cdf720103634b7147ccd89bcb85ac30efdf541367daa0f2c390850d1a8d341d6e37171bc46c7d0dd40de92f1e25ef9f7aeaff16dddbc280');
        account_proof[4] = RLPEncode.writeBytes(hex'f90211a0a5954f4e4d0fdd5a37e6867467a4be9115dff722e5ccb3fb2c37283dd5d51603a034c7606963d151a1cf69f9691b047b2dc54c910683a0a5a2f63ef16cf42f4f6ea027739ecf16d538570cb1dd10fac3fbcc4947dff98cc51adfa85537911f1ec62ea0d8936b41a794f8c070c547d141fb8bd596adcf599fdcc313277a2bb3c25f68c3a05284cbafe0dccae76c73d6b64955f95adc77dcd001cddf0f90530495d6e81bf5a00296067cd4636ed0133edda8dc423de508b84bfad371b387060f42b7c1970f31a05560f85c27b2d3b8ba006977b66164483de9ec1fe84ac0e32d061383e436a6d3a0acd1d0ceabdc8479934b7c430fc8d96e07339950457c141b2378dd10da2466dba0c1c461a1f4083379cd0bb6182e3055688a20aba2cb064beb2a281d331d1ca00ca04b146e2bab4b6c58be3cb021812650ee40bbff7a2d72ad2e5be14b360fc08b66a07f8afc94a8bf4f05d193b0e6592f51cb95bb0e540e00e11941389f9f0fe5bc89a03dc5270c5bb7b97d722dd92f08c1ac9cca723e5969ace9871e6cd6132243cbf1a0518e863bfec34059ddf6e46b4657a89fce48567acc5a480e0c0b2ca4269fa31fa094705db84ab6adf0ae7982780c7742630f5bb661d1dcac1e80d2f00ad678605ca0c7f79171afe04a11c1e50ba2b647d90ef2efd47042754bae82b48cd92e2e3f6ba006a341874608d81dbdd03023f7b4ebc939fba6903aa629f7fad80daa48ac2b8980');
        account_proof[5] = RLPEncode.writeBytes(hex'f901f1a0f917707e49550f2b996ec541e5c07c5e0438135ca8577cfd93295723a8199135a0136774f84e20e0d4cc54d0f86771df33ff7a71f5c716fce828b3f09b6391fc2ca0377bbfff5fb6f4a4e7feece59d91186c4d4b003e3e23c935c6f410327a2476d3a0b2836890f22d75c3a95ada7b609b75a9997a48a11dcfbf645f6a5bade924a0c4a071450d082868865a21985d2594f78b78c7783199118365f83a124362863f7612a05cde7da422cc1955b54b4078d054de8e37b2805c7077613282a0f664615aefeca03e27387c1956ad73dbc6c18f8aaf4d158c0fce5f378ed2c737403d17db10eb8b80a0689847148187a5d0a99e17b9043841b2fe0481e15bc4fa783d21f412574a616ea0cc533d4874e07d8d4e868d601378bca9c288354cea74b0a824a45a1cd9697914a03b4eca732dd04a8581eafd379a1ed3ef1c10dac5a3f27e2a2d25c35056eb34bda0fc8d282f1d8ca3732ffd25de18ec2987b9bf757a6a3e3097344072da02e566bca00324883899e1d9a2b66f71e19eeaf8a32b6313b28f500391aa6eb38119c61261a07ad389ad23fc7373db36d52eab19b9dc574d82358db8a28d0914138f4e6762efa07f85b2277215c39de1db05f41e727d65367b8862c3f09f2b33d3ade903fb3024a05894a37f31a6459c35245c897cbf37a948fb96a7bd9c952cc401a1b126c7b67380');
        account_proof[6] = RLPEncode.writeBytes(hex'f8918080a08c493bb747352aeb7eb9b5bbff376fc07b84a6178552edd5a8f30250d5d4348280808080a01df396569ea87a6378d7dd35e26a654700f94df03421a37918f9868fd4a43c69a067abaabe4b1c0b0c38d79aa67f7d44614570aa95ff46c6837fa3e836e8a42a1680808080a06145441772405e509d424204248af30cda9da4a080b1748ddf5121c3536e2fa0808080');
        account_proof[7] = RLPEncode.writeBytes(hex'f8669d3d6ef56197b6a07600138cb2a498a2139c82f3dff1c1958c3fe99fdc77b846f8440180a088bf311c759a8e9f6dac6b21a06d907ce6f192bdf08aa7de7c2fe008f7956087a0bea4e8de3e083450d67658272d677d5b235afa1fb72bc1ee3aa9b93e4cf7d23f');
        bytes32 storage_key = 0x0000000000000000000000000000000000000000000000000000000000000000;
        bytes[] memory storage_proof = new bytes[](2);
        storage_proof[0] = RLPEncode.writeBytes(hex'f8d1a0dc7313472cd8065ddc532e619f3ef35a9ebfb84191c126f6569b8e774f176e2180a070ba5864d605be428532599eeb5598e3a59860e7d618d04c42b5bdf86d1e6865808080a0541b758702fdb0de028839b604b3e2275a66af6bf174ee824fcc10f65b5f922380808080a050e8102abba78167ad8fd8574a6ccc0eb5a41136f6ad9f091a324b2ceb7cb6ffa00d453ef130e3c18edb02bf0c586c2a4935ab62bb8b6d8f7db06747295b785e3e80a022c6150a0df9e33bf366d5c39a8f37955c3bc4daa01524986f72b737d29354518080');
        storage_proof[1] = RLPEncode.writeBytes(hex'e5a0390decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56383821234');
        assertEq0(StorageProof.verify_single_storage_proof(
            root,
            account,
            RLPEncode.writeList(account_proof),
            storage_key,
            RLPEncode.writeList(storage_proof)
        ), hex'1234');
    }

    function test_message_proof() public {
        bytes32 root = 0x035120011363e48f7b052a26f2329ac34e2a64aba50eaf9fdd6adfd282f616a0;
        address account = 0x7cD44a3C9696185BAC374F0Cd3018F4b24986cb0;
        bytes memory account_proof = hex'f90888b90214f90211a064c4367b075e4c83c591074a290a26fa25b649c02516478c0b996b2f14d55bb5a08da35a37e4185fe03fb1c4d163e8fd0aba4304991f90f4ac8e62ee985c289819a0fc26ec74abe0a275e6267c2822b3aef8a0261420425a58b753ea4492d5edbe93a0b547532ebe6a3a278799397b4abb68e36676ad38690f0561ee23e05c57a884f5a02da6f9848a3153e6fd6ffdece453a8ff9ccc295633da4818850cafc78a87b70ea08fbf868b6ad0a974500b2139dd246e26934c94b0906dee1f5324bb2cec7e3c25a019ff2715dc25c16cebf1b20b9b60c33f090cf7bb1492790f7e5bed76976689c4a019047b4028dfb2687afd1985346d1c906e488100dab653114d75587ec5d010e4a017b01713f6173f0515fd833a1a888c6419ea6efcc83985cbbeb2327b77f166c1a05da0774f47ca8fb6b0f2323dca3cb9454c544f7093d3d6692e4f3f67037bfe40a0d5dfecce3ec8cb1e2d77faae0a9014bf4b09b8398f82e77fa481b7dd519d99aaa08de9b8543423a8a59d33b8f5b707a62dbe1f1ebfcb79bb8533d9fc5f6f9ea8c4a06fb44c98b3fc16ac6dfb79355737c924bc1045176ef9dd355063a53863495c21a07df047a36d79bc6c669feedfdef643a9266706e2cdae6eea7909f7a66eab1754a0b5c2d6b83faadcdcdd227e280ac9607f94b25b6e026965e716fa056533c93b20a0a2badeadb13c5e3aad5a275c98056b01f6e70094dbff44211208fed18142672c80b90214f90211a03081145eff22560c8d724f76d2b04f07d18aaf45d37913b3557654ff786ea640a00ca039265f2d87c833bd60648e5335bf3ce52008b2daafab104024803a0560bea0f6f537219b97a60f86436f5afd980321609fcb8764e6e576534ab38d4f65000ba0c12833660634ad2c92084b38fe49dbde6823c79614ea9ee27b3740d90773c790a08ea08f13daa18d8228e61687eb1e6c36b4474abb1d273c846dffbe1350599210a09f3b90a8e9f517451e7d8d6ef03bd2872075c3eaf16fb2dacc83c542b2a480e9a07613c21d6c91e3880ddcc145312b8e7548aa128fdda817a4ae2571afa5f50d16a022e552136c0afa2f34061278310c0880554c00fd98d5acbf626edf79e21e3569a0a798300622aaed6e6b3a1d2064bb0105486b555ccf38fddd2024647a6f46c074a004e53c83ff38d6cf905f723b387b98a2d9bc924174d0bcad13d998d7bac23edca015aa9c86655a18bb3acd7363557eb766d930a8041f00e72b1351c50c579073c3a0b7887a55a355496fba4332c166008b6149229630c5b32a982371d29c551f7deaa0127d0964741fe8b3ed96240b492829b82610df14cced879d37e4943f58330b87a0342391727fd2095be56a116588888855cf19bf84443cf8c0ef85f98a773bd1a1a0f4021aefb9f0d3709ae6e9827e21dd76237d3ad4198391882ee5c30ba174a385a06e6732c7d9417ffe15207ed26d9667b84fa38aa8e7a5b63df95bbce93fa203f080b90214f90211a03f9ee6608595a033d2f9cc10194a33339169db71c32b084ff042f8827deb6885a084c4f3fb1c8b3c5f1fcdd05e2866a31b8256bf515aed136a7722ec0de50e1e3ba0e272eba34c4560ce873eaa82791135f817e112465ad602898f1e11f4ab0eba66a022f55460166a361786eb4515d9953161bc17cd4216eb25699abfe70d68724c29a091966562fc987dae4f4068f5d55c9d3d3ecfd9ff301d7ebb468fb4317c135a0fa06d94bcaa8a4231ddfb41c3dbdaacab64f11b70129c5f8ab7fd7cbe46fc09ddcea05eb5a9b245cc9d12dfb9555ffbd0c798d64cf4d1aeb2a6eeabdc0c7cbe122e95a0024142c11a2956fcbe98bc99cbb3fe80cee6cf648bc2fbd398222aedfb342d6aa01d0dc51eb198ac905a993c17dad42a66e90bc9928258ff74a516e79de125b67ba06d32027b7e93086ffa2fac9d5fa3ca571f380c637a02f03f7d5016a799a9b1e5a044cfbe4dbd2a20233aa3bb84058bda6de9e5fe9a2c222c7b98809bba1a60c1e6a0be8ce226ea4df0d34820cca2b9d4e4b39d35aa62dd2a22eca1c3910492b06047a0813e73f25cd3c5f59192ab9a4436afd8335507b499965c24f639be954ec5f909a04b51d54423871013b1d7d411c2751776a7aebcbc10fcc9c99720e0aff44af6baa0bc1ce85089fac7030bad9d5907aa95cfeaddca1d19f79ab2a34fb9de021535d3a00cad992ffcd2637a4c68a95c5851fdbc3aad3f13c018c10b3784811f5110ab1280b901d4f901d1a02c782593ff748129c107992e6d7ab0f52f1c4d2a6ef85eddd73ec419fef5739ca04352fb4f24da2ebce721bac2159f011f4e2797b899951ea4f76b6ccfd47f4366a003d55189f41da66dbfc1ddcc3a39931eb96e83e0f49fc7fde0b823a3bf16e5ac80a0b35098056d4536038b320cc8d91c6492644df1b3c12faf2317f6f12bc40cfcbda0dae49d49528f3ff23c59a3d967233643d44bf5b32923d09b7befe51057cea19ea095585215ac8c653a6e4151e6bbb610e318a2acf2378e122696ef5caaf958adfda04e06c7cf03bf15d378136216c8fd37e166a6ac4afd92d3de9aa7b23b55d0f49ba09f9519dbbb0fa7915bca77c6b7203aa0db06327be0c7b660c0e47a017762e0a380a0a38fdd75b693c0becfcd4fd4dddc925caddde72e67ccafbc9ed0f07b4aeb806ca07acad2467e50809c9cf00f20eb9f326b913f7f1d85fd1d1e005db70e1a3f8799a03d7f273660f10fb8a6a42cf53ea7cc1be4982e3df4343dc27dc233ac188be31fa0966dce7b8c41536a26625fd20966900dddd05e90df049fb6b73fe9488ca2ae7fa0ff8f501f8d2060faede47137d283354f4455b87eb5688bb96647446fd4366de7a0a4c39f1f8d7b6deaeeb7493578b8da639004859289c8dc1221f7f3dfa98fe60c80b86af8689f20aeffec0a7877c229a1e3c7cf307dcecc20b54b91344d0e289731375bc371b846f8440180a0eef6cee7784a61155b5e5f33ef7f9187f469a2881b0013054b7887e4e588ea7aa0a83c16d163d96a3551ed93261ee7c7debc77bc2d54058c99918d2cf36aa524b9';
        bytes32 storage_key = 0x0000000000000000000000000000000000000000000000000000000000000000;
        bytes memory storage_proof = hex'f8a7b873f8718080a035a0718dc7f743d6bcf7177d72609d93675d0a0d5b7d5041f7e37f59269a466080808080a06805ef3e1126ba2f15343f306d0709484910f90991252cfa7b2bff54aaf91030808080a01fd52db69d82536d813cd8a6990924c350c07e744b33a396b5afb34f901611e38080808080b1f0a0390decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5638e8d01000000000000000000000001';
        assertEq0(StorageProof.verify_single_storage_proof(
            root,
            account,
            account_proof,
            storage_key,
            storage_proof
        ), hex'01000000000000000000000001');

        storage_key = 0x0000000000000000000000000000000000000000000000000000000000000001;
        storage_proof = hex'f8abb873f8718080a035a0718dc7f743d6bcf7177d72609d93675d0a0d5b7d5041f7e37f59269a466080808080a06805ef3e1126ba2f15343f306d0709484910f90991252cfa7b2bff54aaf91030808080a01fd52db69d82536d813cd8a6990924c350c07e744b33a396b5afb34f901611e38080808080b5f4a0310e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf692910100000000000000010000000000000000';

        assertEq0(StorageProof.verify_single_storage_proof(
            root,
            account,
            account_proof,
            storage_key,
            storage_proof
        ), hex'0100000000000000010000000000000000');

        bytes32[] memory storage_keys = new bytes32[](1);
        storage_keys[0] = 0xe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0;
        bytes[] memory storage_proofs = new bytes[](1);
        storage_proofs[0] = hex'f8bcb873f8718080a035a0718dc7f743d6bcf7177d72609d93675d0a0d5b7d5041f7e37f59269a466080808080a06805ef3e1126ba2f15343f306d0709484910f90991252cfa7b2bff54aaf91030808080a01fd52db69d82536d813cd8a6990924c350c07e744b33a396b5afb34f901611e38080808080b845f843a03fef4bf8f63cf9dd467136c679c02b5c17fcf6322d9562512bf5eb952cf7cc53a1a03340d482234ce7e8a40473a2903cceccffc8c0c39559be0720e1092494ded74c';

        bytes[] memory values = StorageProof.verify_multi_storage_proof(
            root,
            account,
            account_proof,
            storage_keys,
            storage_proofs
        );
        assertTrue(values.length == 1);
        assertEq0(values[0], hex'3340d482234ce7e8a40473a2903cceccffc8c0c39559be0720e1092494ded74c');
    }
}
