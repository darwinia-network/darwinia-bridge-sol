// This file is part of Darwinia.
// Copyright (C) 2018-2022 Darwinia Network
// SPDX-License-Identifier: GPL-3.0
//
// Darwinia is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Darwinia is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Darwinia. If not, see <https://www.gnu.org/licenses/>.

pragma solidity 0.7.6;
pragma abicoder v2;

import "../../test.sol";
import "../../../truth/bsc/BSCLightClient.sol";
import "../../../spec/BinanceSmartChain.sol";

contract BSCLightClientTest2 is DSTest, BinanceSmartChain {
    uint64 constant private CHAIN_ID = 97;
    uint64 constant private PERIOD = 3;

    ParliaWrapper public parlia;

    function setUp() public {
        BSCHeader memory genesis_header = build_genesis_header();
        parlia = new ParliaWrapper(CHAIN_ID, PERIOD, genesis_header);
    }

    function test_constructor_args() public {
        BSCHeader memory header = build_genesis_header();
        assert_finalized_checkpoint(header);
    }

    function assert_finalized_checkpoint(BSCHeader memory cp) internal {
        (
            bytes32 parent_hash,
            bytes32 state_root,
            bytes32 transactions_root,
            bytes32 receipts_root,
            uint256 number,
            uint256 timestamp,
            bytes32 hash
        ) = parlia.finalized_checkpoint();
        assertEq(parent_hash, cp.parent_hash);
        assertEq(state_root, cp.state_root);
        assertEq(receipts_root, cp.receipts_root);
        assertEq(transactions_root, cp.transactions_root);
        assertEq(number, cp.number);
        assertEq(timestamp, cp.timestamp);
        assertEq(hash, parlia.hash_block(cp));
        address[] memory expected_signers = parlia.extract_authorities(cp.extra_data);
        assertEq(parlia.length_of_finalized_authorities(), expected_signers.length);
        for (uint i = 0; i < expected_signers.length; i++) {
            assertEq(parlia.finalized_authorities_at(i), expected_signers[i]);
        }
    }

    function test_recover_creator() public {
        BSCHeader memory header = build_genesis_header();
        address creator = parlia.recover_creator(header);
        assertEq(creator, header.coinbase);
    }

    function test_extract_authorities() public {
        BSCHeader memory header = build_genesis_header();
        address[] memory signers = parlia.extract_authorities(header.extra_data);
        address[] memory expected_signers = build_expected_signers();
        assertEq(signers.length, expected_signers.length);
        for (uint i = 0; i < signers.length; i++) {
            assertEq(signers[i], expected_signers[i]);
        }
    }

    function testFail_import_finalized_epoch_header() public {
        BSCHeader memory checkpoint = build_checkpoint();
        BSCHeader[] memory headers = new BSCHeader[](1);
        headers[0] = checkpoint;
        parlia.import_finalized_epoch_header(headers);
    }

    function test_import_finalized_epoch_header() public {
        BSCHeader[] memory headers = build_headers_9516600_to_9516605();
        parlia.import_finalized_epoch_header(headers);
        BSCHeader memory checkpoint = headers[0];
        assert_finalized_checkpoint(checkpoint);
    }

    function build_headers_9516600_to_9516605() internal pure returns (BSCHeader[] memory) {
        BSCHeader[] memory headers = new BSCHeader[](6);
        headers[0] = BSCHeader({
			difficulty: 0x2,
			extra_data: hex'd883010100846765746888676f312e31352e35856c696e75780000001600553d1284214b9b9c85549ab3d2b972df0deef66ac2c935552c16704d214347f29fa77f77da6d75d7c7523679479c2402e921db00923e014cd439c606c5967a1a4ad9cc746a70ee58568466f7996dd0ace4e896c5d20b2a975c050e4220be276ace4892f4b41a980a75ecd1309ea12fa2ed87a8744fbfc9b863d5a2959d3f95eae5dc7d70144ce1b73b403b7eb6e0b71b214cb885500844365e95cd9942c7276e7fd8c89c669357d161d57b0b255c94ea96e179999919e625dd7ad2f7b88723857946a41af646c589c336e1e7e55c0f0a308c989ebccef3276256a33372647b4f9b61ab82666dd67af8e7404995bd96d87b056f46203d012ed3e4521788f19c4c6d434a23e3b8df112e1a01',
			gas_limit: 0x1c7f9be,
			gas_used: 0x5a8896,
			log_bloom: hex'00a04000000000000022100080001080000040002000420000800000000010008000410000001800010000400041400c0008000301150000400000000022600001400000801002220001000808000221601300000100000000000c0040000000000100200a1200008000400000000800000000000200100040100111000400408800050000410040400202004000000008000444000811080000204400000080020000040000000041000000020000000000000033000000400011102200000000000102000001000000000000108e00000020400208001000200400000021010110000200000820410000004000020001200000080804480160600800080000',
			coinbase: 0x1284214b9b9c85549aB3D2b972df0dEEf66aC2c9,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x913638,
			parent_hash: 0x017203a062da40a61596fff8df385e1803a37d912e9443c8ca274946edbe12f2,
			receipts_root: 0xa38d1c3c3deea5647a2a397f51aa52c70af96492dd945033b1ea190f4661e1ea,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0xd6350b59463b0f85e66ce7baf8f2d11c4861377ecefe31b79db3613f4ef22a52,
			timestamp: 0x60bdbb95,
			transactions_root: 0x6035819fcd17bc49a5f3035bd056d54258bcaaedff556ce4915c49f506c8fea7
        });
        headers[1] = BSCHeader({
			difficulty: 0x2,
			extra_data: hex'd883010a02846765746888676f312e31352e35856c696e75780000001600553d2e38fac35164660fa0ee02276627713ffd348ac3d84da664c5e1a84fc92c96a30109c7c0b56ff5f0d509f354424ad5beb58cdf2e107699bb5261b63ca8bb1b1c01',
			gas_limit: 0x1c9c1b6,
			gas_used: 0x2ef79,
			log_bloom: hex'00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002010000000000000000000000000000000000020000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000080000000000000000000000002010000000000000000000000000000000000000000000000',
			coinbase: 0x35552c16704d214347f29Fa77f77DA6d75d7C752,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x913639,
			parent_hash: 0x34b15d2bdd589884741d5f2b0e4be29a5dcdc469c0cc27ac7e31f807efaeacb9,
			receipts_root: 0x76ba0a3fd5f4730528a08b7353b659d066c46bf602e0f6952a261c4202733661,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0x2b78dda7c0b808ee9d5b8151bfd3a60b1a58269c8f8b463284f5a4690f43650b,
			timestamp: 0x60bdbb98,
			transactions_root: 0x055d4a0f0fdf0ae45fed0e98df2bf76b3c6c52a86cde638e6387bff40fb656e5
        });
        headers[2] = BSCHeader({
            difficulty: 0x2,
			extra_data: hex'd883010006846765746888676f312e31352e35856c696e75780000001600553d6d3988c21ec42f01b7c92a55ba1388d19587eb3740fec47a7f70c69021049d3978b2e055212959e1694a1636fb95e6302a6c404c380928e88eaa12e2b7f0055700',
			gas_limit: 0x1c9c380,
			gas_used: 0xb991,
			log_bloom: hex'00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002010000000000000000000000000000000000020000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000480000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000',
			coinbase: 0x3679479c2402e921db00923E014CD439c606C596,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x91363a,
			parent_hash: 0x3474ad7643d2f7a5fcfcd4c4cf58ebf5bebd278fc6e54c58ed2b2ac3638271de,
			receipts_root: 0x1493fee3f10464b3726beed5e508a14394ee0fa3bf4fce1e1f09361280e66778,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0xffa5ea329d920b70effd115b44a465a77d6efbb130bc08152e010afd6c823984,
			timestamp: 0x60bdbb9b,
			transactions_root: 0xe426d705ad680875a68e12f591ea16793cbde303f38676ef511601bf5a1114ba
        });
        headers[3] = BSCHeader({
            difficulty: 0x2,
			extra_data: hex'd883010007846765746888676f312e31352e38856c696e75780000001600553d51a38238db7900a9a570de3d58abf15e2b5fcf40ce3e60a45ed1707088148be61dc9053a83d6eae2f7a92779cc8554ce96af5e2eb532207c64fd6eb0eb037aba00',
			gas_limit: 0x1c9c380,
			gas_used: 0x6e327,
			log_bloom: hex'0100000000100000000040000001000002000000040000000000001000000020100000000000000000080000000108000a000000200000000000000000240000000000000000000000100008000000002018000001040000000000000002000000200020020200000000000020400820000008000000100000000010000000000000000000018000400800000000001000001400010800000000000000800000020000000000000000000000000000000000000000000080000000002000100020000002000000800280000000040000000000000008000022000000002060000110000000000000010000000000000040000000400000000000010000000000',
			coinbase: 0x7a1A4Ad9cc746a70ee58568466f7996dD0aCE4E8,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x91363b,
			parent_hash: 0x1cee01e6f8ce42c1b2539e3d31e4a4f4687b991e44efc792dd5178cbb7c13c54,
			receipts_root: 0x79f6fc41f28df8960cc1758f4cd6f7c30202b3411d58084248fceb2105f3cd03,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0x352ede79848c26875970389970ea265feae15514472c4336e37647e8f3f03258,
			timestamp: 0x60bdbb9e,
			transactions_root: 0x34e5386aaed532c1b9a2be24b2e3a16ded8a6fed18eb7c0924d5ab2455b4ddd5
        });
        headers[4] = BSCHeader({
            difficulty: 0x2,
			extra_data: hex'd883010006846765746888676f312e31352e35856c696e75780000001600553df1e86c16a7f5c32d87b4717d1ca0a2df81da61f4f0316decb6f93afc0b50d5ad6471c8382332991f1877aedfda846758aa323d50dc8f7b7465a044bbd44e3fd501',
			gas_limit: 0x1c9c380,
			gas_used: 0x947c3,
			log_bloom: hex'00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000002010000000000000000000000000000000000020000200000000000000020000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000',
			coinbase: 0x96C5D20b2a975c050e4220BE276ACe4892f4b41A,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x91363c,
			parent_hash: 0xe03a7e316914333134299eb3b74f8853d7c0de416de839a0fa48347f868f644a,
			receipts_root: 0x752e53876a0a9737065ff7ee62527f757ccbcefd9c9b866fa7edc6311844fd0a,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0x3154975e092d9a613dc695cf97019bcf697455f839c5aa880189b1695e31987e,
			timestamp: 0x60bdbba1,
			transactions_root: 0x2748038d0f7b4e8d8898c005c36dc1bf94f570c9f345587bbcc6d3ddf00d395b
        });
        headers[5] = BSCHeader({
			difficulty: 0x2,
			extra_data: hex'd883010a02846765746888676f312e31352e35856c696e75780000001600553da8f7afce6ac0d9d4906b34ff2f6bb4c46f9b7d26917a87ff2581078fb030286149d59244743d1d7b2f94495853abf8e235085cf331eb92e1b4348c44f24bc87301',
			gas_limit: 0x1c9c380,
			gas_used: 0x2ee8a0,
			log_bloom: hex'0000000000080400000000200000000000000000800040400000000000000800000140010000000000001000000010000000000000000000000000000000040000108000000000000000000800000000201000000000000000100000000000000000042002021000004000000000080000040000000000000010001010000000000000a000000000000000004001000810000c00000000000000000000000000000000000008000000000000400002000000000000000000400000000000040000000002000000000800000000000000040000000000000000000000000020000000000000000000010000000080600000000000000000200100000000000000',
			coinbase: 0x980A75eCd1309eA12fa2ED87A8744fBfc9b863D5,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x91363d,
			parent_hash: 0xdec8d3e6f941abb1342cae0b31fcd29df3582e86518691995cb4fe6da094a26c,
			receipts_root: 0xcae8041526afbf5b3a48999d2b1899f88ccddadb282bc478b8f1bc0ee0391263,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0xbf3dd879dea5eb15f906f12e2b4f6146f1838f39cac6a9aa82476d98843a144c,
			timestamp: 0x60bdbba4,
			transactions_root: 0x9b4b2eac1f62e7075f1dbe3ebf0008e882980beb1ff4bacf4d81d11454f41106
        });
        return headers;
    }

    function build_expected_signers() internal pure returns (address[] memory) {
        address[] memory expected_signers = new address[](10);
        expected_signers[0]  = 0x1284214b9b9c85549aB3D2b972df0dEEf66aC2c9;
        expected_signers[1]  = 0x35552c16704d214347f29Fa77f77DA6d75d7C752;
        expected_signers[2]  = 0x3679479c2402e921db00923E014CD439c606C596;
        expected_signers[3]  = 0x7a1A4Ad9cc746a70ee58568466f7996dD0aCE4E8;
        expected_signers[4]  = 0x96C5D20b2a975c050e4220BE276ACe4892f4b41A;
        expected_signers[5]  = 0x980A75eCd1309eA12fa2ED87A8744fBfc9b863D5;
        expected_signers[6]  = 0xA2959D3F95eAe5dC7D70144Ce1b73b403b7EB6E0;
        expected_signers[7]  = 0xB71b214Cb885500844365E95CD9942C7276E7fD8;
        expected_signers[8]  = 0xc89C669357D161d57B0b255C94eA96E179999919;
        expected_signers[9]  = 0xE625DD7AD2f7b88723857946A41Af646c589C336;
        return expected_signers;
    }

    function build_checkpoint() internal pure returns (BSCHeader memory header) {
        header = BSCHeader({
			difficulty: 0x2,
			extra_data: hex'd883010100846765746888676f312e31352e35856c696e75780000001600553d1284214b9b9c85549ab3d2b972df0deef66ac2c935552c16704d214347f29fa77f77da6d75d7c7523679479c2402e921db00923e014cd439c606c5967a1a4ad9cc746a70ee58568466f7996dd0ace4e896c5d20b2a975c050e4220be276ace4892f4b41a980a75ecd1309ea12fa2ed87a8744fbfc9b863d5a2959d3f95eae5dc7d70144ce1b73b403b7eb6e0b71b214cb885500844365e95cd9942c7276e7fd8c89c669357d161d57b0b255c94ea96e179999919e625dd7ad2f7b88723857946a41af646c589c336e1e7e55c0f0a308c989ebccef3276256a33372647b4f9b61ab82666dd67af8e7404995bd96d87b056f46203d012ed3e4521788f19c4c6d434a23e3b8df112e1a01',
			gas_limit: 0x1c7f9be,
			gas_used: 0x5a8896,
			log_bloom: hex'00a04000000000000022100080001080000040002000420000800000000010008000410000001800010000400041400c0008000301150000400000000022600001400000801002220001000808000221601300000100000000000c0040000000000100200a1200008000400000000800000000000200100040100111000400408800050000410040400202004000000008000444000811080000204400000080020000040000000041000000020000000000000033000000400011102200000000000102000001000000000000108e00000020400208001000200400000021010110000200000820410000004000020001200000080804480160600800080000',
			coinbase: 0x1284214b9b9c85549aB3D2b972df0dEEf66aC2c9,
			mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
			nonce: 0x0000000000000000,
			number: 0x913638,
			parent_hash: 0x017203a062da40a61596fff8df385e1803a37d912e9443c8ca274946edbe12f2,
			receipts_root: 0xa38d1c3c3deea5647a2a397f51aa52c70af96492dd945033b1ea190f4661e1ea,
			uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
			state_root: 0xd6350b59463b0f85e66ce7baf8f2d11c4861377ecefe31b79db3613f4ef22a52,
			timestamp: 0x60bdbb95,
			transactions_root: 0x6035819fcd17bc49a5f3035bd056d54258bcaaedff556ce4915c49f506c8fea7
        });
    }

    function build_genesis_header() internal pure returns (BSCHeader memory header) {
        header = BSCHeader({
            difficulty: 0x2,
            extra_data: hex'd883010100846765746888676f312e31352e35856c696e75780000001600553d1284214b9b9c85549ab3d2b972df0deef66ac2c935552c16704d214347f29fa77f77da6d75d7c7523679479c2402e921db00923e014cd439c606c5967a1a4ad9cc746a70ee58568466f7996dd0ace4e896c5d20b2a975c050e4220be276ace4892f4b41a980a75ecd1309ea12fa2ed87a8744fbfc9b863d5a2959d3f95eae5dc7d70144ce1b73b403b7eb6e0b71b214cb885500844365e95cd9942c7276e7fd8c89c669357d161d57b0b255c94ea96e179999919e625dd7ad2f7b88723857946a41af646c589c3362af12db7da187b9d47f600a1e0c15639d477674640fa9d5fbf9dfaf1d84525f128a3c90b7480be53ad77703837dfead0b31186c4103b85ea08e2c37006e7c41301',
            gas_limit: 0x01c7f9be,
            gas_used: 0x1a478c,
            log_bloom: hex'0000200080200000000041000020000002000000080000000800010000400000000800010002000000800201000000841000044000002200000000001020000a000800001000000000000008000000212010000000100000000000022002000200a080201022102208000000200000004000080080000000000000100010000000802000000001000008000040008410000005400100000200000004000000000300200000000080001000000800000000000000000020800202400005001400140000020000002008002000080001000000000000004400208000800800000404100004008450004100000800000040402000000000800808000b0000400000',
            coinbase: 0x1284214b9b9c85549aB3D2b972df0dEEf66aC2c9,
            mix_digest: 0x0000000000000000000000000000000000000000000000000000000000000000,
            nonce: 0x0000000000000000,
            number: 0x913570,
            parent_hash: 0x58ff628185cd8d77c8592c7349180731fc8f85a8f46be7d7aba572eafbc2ffb7,
            receipts_root: 0x707b7daac57a5e13c01b3cbcc00f444860cb44b003b468788716464135faba15,
            uncle_hash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,
            state_root: 0x65918191d85321efd8e2b0d9970c316342c62ebfd590198b8e4900f746a20a96,
            timestamp: 0x60bdb93d,
            transactions_root: 0xe2b722a634ec82422a09a24ba0bc2c3ae4d83df764b872fd24c464634df399cf
        });
    }
}

contract ParliaWrapper is BSCLightClient {
    constructor(uint64 chain_id, uint64 period, BSCHeader memory header) BSCLightClient(chain_id, period) {
        initialize(msg.sender, header);
    }

    function recover_creator(BSCHeader memory header) public view returns (address) {
        return _recover_creator(header);
    }

    function extract_authorities(bytes memory extra_data) public pure returns (address[] memory) {
        return _extract_authorities(extra_data);
    }

    function hash_block(BSCHeader memory header) public pure returns (bytes32) {
        return hash(header);
    }
}
