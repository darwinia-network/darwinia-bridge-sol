#!/usr/bin/env bash

set -e

export NETWORK_NAME=pangoro
export TARGET_CHAIN=bsctest
# export ETH_RPC_URL=https://pangoro-rpc.darwinia.network
export ETH_RPC_URL=http://35.247.165.91:9933

echo "ETH_FROM: ${ETH_FROM}"

. $(dirname $0)/base.sh
load-addresses

# darwinia to bsc bridge config
this_chain_pos=0
this_out_lane_pos=0
this_in_lane_pos=1
bridged_chain_pos=2
bridged_in_lane_pos=1
bridged_out_lane_pos=0

# fee market config
FEEMARKET_VAULT=$ETH_FROM
COLLATERAL_PERORDER=$(seth --to-wei 10 ether)
ASSIGNED_RELAYERS_NUMBER=3
SLASH_TIME=86400
RELAY_TIME=86400
# 0.01 : 300
PRICE_RATIO=999900

FeeMarket=$(deploy FeeMarket \
  $FEEMARKET_VAULT \
  $COLLATERAL_PERORDER \
  $ASSIGNED_RELAYERS_NUMBER \
  $SLASH_TIME $RELAY_TIME \
  $PRICE_RATIO)

# bsc light client config
DATA=$(ethabi encode params -v uint64 0000000000000000000000000000000000000000000000000000000000000061 -v uint64 0000000000000000000000000000000000000000000000000000000000000003 -v '(bytes32,bytes32,address,bytes32,bytes32,bytes32,bytes,uint256,uint256,uint64,uint64,uint64,bytes,bytes32,bytes8)' '(017203a062da40a61596fff8df385e1803a37d912e9443c8ca274946edbe12f2,1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347,1284214b9b9c85549aB3D2b972df0dEEf66aC2c9,d6350b59463b0f85e66ce7baf8f2d11c4861377ecefe31b79db3613f4ef22a52,6035819fcd17bc49a5f3035bd056d54258bcaaedff556ce4915c49f506c8fea7,a38d1c3c3deea5647a2a397f51aa52c70af96492dd945033b1ea190f4661e1ea,00a04000000000000022100080001080000040002000420000800000000010008000410000001800010000400041400c0008000301150000400000000022600001400000801002220001000808000221601300000100000000000c0040000000000100200a1200008000400000000800000000000200100040100111000400408800050000410040400202004000000008000444000811080000204400000080020000040000000041000000020000000000000033000000400011102200000000000102000001000000000000108e00000020400208001000200400000021010110000200000820410000004000020001200000080804480160600800080000,0000000000000000000000000000000000000000000000000000000000000002,0000000000000000000000000000000000000000000000000000000000913638,0000000000000000000000000000000000000000000000000000000001c7f9be,00000000000000000000000000000000000000000000000000000000005a8896,0000000000000000000000000000000000000000000000000000000060bdbb95,d883010100846765746888676f312e31352e35856c696e75780000001600553d1284214b9b9c85549ab3d2b972df0deef66ac2c935552c16704d214347f29fa77f77da6d75d7c7523679479c2402e921db00923e014cd439c606c5967a1a4ad9cc746a70ee58568466f7996dd0ace4e896c5d20b2a975c050e4220be276ace4892f4b41a980a75ecd1309ea12fa2ed87a8744fbfc9b863d5a2959d3f95eae5dc7d70144ce1b73b403b7eb6e0b71b214cb885500844365e95cd9942c7276e7fd8c89c669357d161d57b0b255c94ea96e179999919e625dd7ad2f7b88723857946a41af646c589c336e1e7e55c0f0a308c989ebccef3276256a33372647b4f9b61ab82666dd67af8e7404995bd96d87b056f46203d012ed3e4521788f19c4c6d434a23e3b8df112e1a01,0000000000000000000000000000000000000000000000000000000000000000,0000000000000000)')
BSCLightClient=$(deploy_v2 BSCLightClient $DATA)

OutboundLane=$(deploy OutboundLane \
  $BSCLightClient \
  $FeeMarket \
  $this_chain_pos \
  $this_out_lane_pos \
  $bridged_chain_pos \
  $bridged_in_lane_pos 1 0 0)

InboundLane=$(deploy InboundLane \
  $BSCLightClient \
  $this_chain_pos \
  $this_in_lane_pos \
  $bridged_chain_pos \
  $bridged_out_lane_pos 0 0)

LaneMessageCommitter=$(deploy LaneMessageCommitter $this_chain_pos $bridged_chain_pos)
seth send -F $ETH_FROM $LaneMessageCommitter "registry(address,address)" $OutboundLane $InboundLane
seth send -F $ETH_FROM $ChainMessageCommitter "registry(address)" $LaneMessageCommitter

seth send -F $ETH_FROM $FeeMarket "setOutbound(address,uint)" $OutboundLane 1
