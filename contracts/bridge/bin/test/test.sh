#!/usr/bin/env bash

set -e

unset TARGET_CHAIN
unset NETWORK_NAME
unset ETH_RPC_URL
unset SETH_CHAIN
export NETWORK_NAME=goerli
export TARGET_CHAIN=pangolin

. $(dirname $0)/base.sh

bytecode=608060405234801561001057600080fd5b5061056f806100206000396000f3fe6080604052600436106100345760003560e01c8063142c2a6a1461003957806337267fd91461005b578063914a2fc714610095575b600080fd5b34801561004557600080fd5b5061005961005436600461029a565b6100a8565b005b34801561006757600080fd5b50610081610076366004610314565b600195945050505050565b604051901515815260200160405180910390f35b6100596100a33660046103b6565b6100bd565b60005b806100b581610404565b9150506100ab565b6040516000906100f3907f142c2a6a000000000000000000000000000000000000000000000000000000009084906020016104c7565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0818403018152908290527f303d8a12000000000000000000000000000000000000000000000000000000008252915073ffffffffffffffffffffffffffffffffffffffff84169063303d8a129034906101779030908690600401610502565b60206040518083038185885af1158015610195573d6000803e3d6000fd5b50505050506040513d601f19601f820116820180604052508101906101ba9190610531565b50505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082601f83011261020057600080fd5b813567ffffffffffffffff8082111561021b5761021b6101c0565b604051601f83017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f01168101908282118183101715610261576102616101c0565b8160405283815286602085880101111561027a57600080fd5b836020870160208301376000602085830101528094505050505092915050565b6000602082840312156102ac57600080fd5b813567ffffffffffffffff8111156102c357600080fd5b6102cf848285016101ef565b949350505050565b803563ffffffff811681146102eb57600080fd5b919050565b803573ffffffffffffffffffffffffffffffffffffffff811681146102eb57600080fd5b60008060008060006080868803121561032c57600080fd5b610335866102d7565b9450610343602087016102d7565b9350610351604087016102f0565b9250606086013567ffffffffffffffff8082111561036e57600080fd5b818801915088601f83011261038257600080fd5b81358181111561039157600080fd5b8960208285010111156103a357600080fd5b9699959850939650602001949392505050565b600080604083850312156103c957600080fd5b6103d2836102f0565b9150602083013567ffffffffffffffff8111156103ee57600080fd5b6103fa858286016101ef565b9150509250929050565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361045c577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b5060010190565b6000815180845260005b818110156104895760208185018101518683018201520161046d565b5060006020828601015260207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011685010191505092915050565b7fffffffff00000000000000000000000000000000000000000000000000000000831681526040602082015260006102cf6040830184610463565b73ffffffffffffffffffffffffffffffffffffffff831681526040602082015260006102cf6040830184610463565b60006020828403121561054357600080fd5b815167ffffffffffffffff8116811461055b57600080fd5b939250505056fea164736f6c6343000811000a

large=0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff

SOURCE_MALICOUSAPP=$(seth send --create $bytecode --chain $NETWORK_NAME)
TARGET_MALICOUSAPP=$(seth send --create $bytecode --chain $TARGET_CHAIN)

SOURCE_FEEMARKET=$(load_saddr "FeeMarketProxy")
TARGET_FEEMARKET=$(load_taddr "FeeMarketProxy")

SOURCE_SERIALOUTBOUNDLANE=$(load_saddr "SerialOutboundLane")
TARGET_SERIALOUTBOUNDLANE=$(load_taddr "SerialOutboundLane")

target_fee=$(seth call $TARGET_FEEMARKET "market_fee()(uint)")

for i in $(seq 0 20)
do
  source_fee=$(seth call $SOURCE_FEEMARKET "market_fee()(uint)")
  seth send -V $source_fee $SOURCE_MALICOUSAPP "malicious(address,bytes)" $SOURCE_SERIALOUTBOUNDLANE $large --chain $NETWORK_NAME
done

for i in $(seq 0 20)
do
  target_fee=$(seth call $TARGET_FEEMARKET "market_fee()(uint)")
  seth send -V $target_fee $TARGET_MALICOUSAPP "malicious(address,bytes)" $TARGET_SERIALOUTBOUNDLANE $large --chain $TARGET_CHAIN
done
